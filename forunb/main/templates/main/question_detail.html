{% extends "base.html" %}

{% block content %}

{% load custom_filters %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>

<style>
    .answer-list {
        min-height: 50vh; /* Define a altura mínima como 50% da altura da tela */
        max-height: 70vh; /* Define a altura máxima como 70% da altura da tela */
        overflow-y: auto; /* Adiciona uma barra de rolagem vertical se o conteúdo ultrapassar a altura máxima */
        padding: 1rem; /* Adiciona um espaçamento interno */
        background-color: #f9f9f9; /* Adiciona uma cor de fundo para melhor visualização */
        border-radius: 8px; /* Adiciona bordas arredondadas */
    }
    /* Estilos adicionais para o Cropper.js */
    .img-container {
        max-width: 100%;
    }
    .img-preview {
        overflow: hidden;
        margin: 10px;
        border: 1px solid #ccc;
    }
</style>

<div class="custom-container mt-5 ms-0">
    <div class="questions-item">
        <div class="question-info">
            <div class="return-container">
                <a href="{% url 'main:forum_detail' question.forum.id %}" class="btn btn-return mb-3"><i class="bi bi-arrow-return-left"></i></a>
            </div>
            <div class="question-meta">
                <span class="question-author">
                    {% if question.is_anonymous %}
                        Anônimo
                    {% else %}
                        {{ question.author.username }}
                    {% endif %}
                </span> • 
                <span class="question-date">há {{ question.created_at|custom_timesince }}</span>
            </div>
            <h5 class="question-title">{{ question.title }}</h5>
            <p class="question-description">{{ question.description }}</p>
            {% if question.image %}
                <img src="{{ question.image.url }}" alt="Imagem da pergunta" class="img-fluid mt-3">
            {% endif %}
            <div class="action-buttons">
                <button class="btn btn-like" onclick="toggleLike(this);">
                    <i class="bi bi-heart"></i>
                </button>
                <a href="{% url 'main:question_detail' question.id %}" class="btn btn-info">
                    <i class="bi bi-chat-left-text"></i> {{ question.answers.count }}
                </a>
            </div>   
            <div class="response-area">
                <input type="text" class="form-control" placeholder="Adicionar uma resposta" onclick="showResponseForm()" readonly>
                <div class="response-form d-none">
                    <form method="post" action="{% url 'main:new_answer' question.id %}" enctype="multipart/form-data" onsubmit="return submitForm(event)">
                        {% csrf_token %}
                        <textarea name="text" class="form-control mt-2" placeholder="Escreva sua resposta..."></textarea>
                        <div class="form-group mt-3">
                            <label for="image">Imagem:</label>
                            <input type="file" id="image" name="image" class="form-control-file" accept="image/*" onchange="showCropper(event)">
                            <div class="img-container mt-3">
                                <img id="cropper-image" style="max-width: 100%;">
                            </div>
                            <div class="img-preview mt-3" style="width: 200px; height: 200px;"></div>
                        </div>
                        <div class="form-check mt-2">
                            <input type="checkbox" name="is_anonymous" class="form-check-input" id="isAnonymous">
                            <label class="form-check-label" for="isAnonymous">Responder anonimamente</label>
                        </div>
                        <div class="mt-1">
                            <button type="button" class="btn btn-cancel" onclick="cancelResponse()">Cancelar</button>
                            <button type="submit" class="btn btn-send">Enviar</button>
                        </div>
                        <div id="loading-spinner">
                            <p>Carregando...</p>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="answer-list">
        {% if answers %}
            {% for answer in answers %}
                <div class="answer-item">
                    <div class="answer-info">
                        <div class="answer-meta">
                            <span class="answer-author">
                                {% if answer.is_anonymous %}
                                    Anônimo
                                {% else %}
                                    {{ answer.author.username }}
                                {% endif %}
                            </span> • 
                            <span class="answer-date">há {{ answer.created_at|custom_timesince }}</span>
                        </div>
                        <p class="answer-text">{{ answer.text }}</p>
                        {% if answer.image %}
                            <img src="{{ answer.image.url }}" alt="Imagem da resposta" class="img-fluid mt-3">
                        {% endif %}
                        <div class="action-buttons-answer">
                            <button class="btn btn-like" onclick="toggleLike(this);">
                                <i class="bi bi-heart"></i>
                            </button>
                            <a href="{% url 'main:question_detail' question.id %}" class="btn btn-info">
                                <i class="bi bi-chat-left-text"></i> {{ answer.answers.count }}
                            </a>
                        </div>   
                    </div>
                    <hr class="answer-separator">
            {% empty %}
                <p>Nenhuma resposta encontrada para esta pergunta.</p>
            {% endfor %}
        {% else %}
            <p>Nenhuma resposta encontrada para esta pergunta.</p>
        {% endif %}
    </div>
</div>

<script>
    let cropper;
    const image = document.getElementById('cropper-image');

    function showCropper(event) {
    const files = event.target.files;
    if (files && files.length > 0) {
        const file = files[0];
        const validImageTypes = ['image/jpeg', 'image/png', 'image/gif'];
        if (!validImageTypes.includes(file.type)) {
            alert('Por favor, selecione uma imagem válida (JPEG, PNG, GIF).');
            event.target.value = ''; // Limpa o input
            return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
            image.src = e.target.result;
            if (cropper) {
                cropper.destroy();
            }
            cropper = new Cropper(image, {
                aspectRatio: 1,
                viewMode: 1,
                preview: '.img-preview',
            });
        };
        reader.readAsDataURL(file);
        }
    }


    function submitForm(event) {
        event.preventDefault();
        const form = event.target;

        if (cropper) {
            cropper.getCroppedCanvas().toBlob((blob) => {
                const formData = new FormData(form);
                const fileName = 'cropped_image.png'; // Define o nome do arquivo com a extensão adequada
                const croppedImage = new File([blob], fileName, { type: 'image/png' });
                formData.append('image', croppedImage);

                fetch(form.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Erro ao enviar a resposta.');
                        console.error('Erro:', data.errors);
                    }
                })
                .catch(error => {
                    console.error('Erro:', error);
                    alert('Erro ao enviar a resposta.');
                });
            }, 'image/png');
        } else {
            form.submit();
        }
    }

    function showResponseForm() {
        var responseInput = document.querySelector('.response-area input');
        var responseForm = document.querySelector('.response-form');
        var textarea = responseForm.querySelector('textarea');

        if (responseInput && responseForm && textarea) {
            responseInput.classList.add('d-none');
            responseForm.classList.remove('d-none');
            textarea.focus(); // Coloca o foco no campo de texto
        } else {
            console.error('Elementos não encontrados.');
        }
    }

    function cancelResponse() {
        var responseInput = document.querySelector('.response-area input');
        var responseForm = document.querySelector('.response-form');
        
        if (responseInput && responseForm) {
            responseInput.classList.remove('d-none');
            responseForm.classList.add('d-none');
        } else {
            console.error('Elementos não encontrados.');
        }
    }

    function toggleLike(element) {
        var icon = element.querySelector('i');
        if (icon.classList.contains('bi-heart')) {
            icon.classList.remove('bi-heart');
            icon.classList.add('bi-heart-fill');
        } else {
            icon.classList.remove('bi-heart-fill');
            icon.classList.add('bi-heart');
        }
    }
</script>

{% endblock %}
